/*
console.log('hello, world!');

var spawn = require('child_process').spawn;

console.log('server', 'Spawning mplayer...');
mplayer = spawn('mplayer', ['-idle', '-slave']);
console.log('server', 'mplayer child pid: ' + mplayer.pid);

mplayer.stdout.on('data', function(data) {
	console.log('mplayer data:', data.toString());
});

mplayer.on('exit', function() {
	console.log('exiting mplayer...');
});

var m = 'loadfile "/media/mmc1/sounds/Chesky\ Records\ -\ The\ Body\ Acoustic/4-Hell\'s\ Kitchen.flac"';
mplayer.stdin.write(m + '\n');
*/

var MPlayer = function() {
	
	console.log('MPlayer!');
	
	var spawn = require('child_process').spawn,
		mplayer = spawn('mplayer', ['-idle', '-slave']),
		fs = require('fs'),
		mm = require('musicmetadata');						// https://www.npmjs.org/package/musicmetadata
	
	function _addEvents() {	
		mplayer.stdout.on('data', function(data) {
			//console.log(data);
			console.log('mplayer data:', data.toString());
		});
		
		mplayer.on('exit', function() {
			console.log('exiting mplayer...');
		});
	}
	
	function _initMetaDataParser(path) {
		var parser = mm(fs.createReadStream(path));
		parser.on('metadata', function (result) {
		  console.log('metadata received:' + JSON.stringify(result, null, 2));
		});
		
		parser.on('artist', function (result) {
		  console.log('artist', result);
		});	
	}
		
	function _sendCommand(cmd) {
		mplayer.stdin.write(cmd + '\n');
	}
		
	this.play = function(path) {
		console.log('MPlayer.play', path);
		
		_initMetaDataParser(path);
		
		var m = 'loadfile "' + path + '"';
		_sendCommand(m);
	};
	
	this.pause = function() {
		
	};
	
	this.stop = function() {
		
	};
	
	_addEvents();
	
};

module.exports = new MPlayer();